# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0

name                gds-swig
version             2.19.4
revision            0

categories          science
platforms           darwin
license             GPL
maintainers         {@emaros ligo.org:ed.maros} openmaintainer

description         LSC Algorithm Library
long_description    LIGO Scientific Collaboration Algorithm Library containing core \
                    routines for gravitational wave data analysis.

homepage            https://git.ligo.org/gds/gds
master_sites        https://software.ligo.org/lscsoft/source/

checksums           rmd160  14d455398a248ed44e92abb38455cec5b5f59a31 \
                    sha256  de65a6110340ff58e6c1fdf81990917b671e34c76ba84785087337fca07778b7 \
                    size    409058

depends_build-append \
                    port:pkgconfig \
                    port:autoconf \
                    port:automake \
                    port:swig

depends_lib-append  port:gds

regsub -all -- "-swig$" ${name} {} basename

configure.args-append \
                    --enable-online \
                    --disable-python \
                    --enable-dtt

post-destroot {
    if {${subport} eq "${name}"} {
        set fp [open "${workpath}/README.txt" w+]
        puts ${fp} "This is the SWIG stub for GDS language bindings"
        close ${fp}
        set docdir ${prefix}/share/doc/${name}
        xinstall -d ${destroot}${docdir}
        xinstall -m 0644 ${workpath}/README.txt ${destroot}${docdir}
    }
}

#========================================================================
# Create subports for each supported Python version
#========================================================================
foreach v {27 35 36 37 38} {
  set python.version        ${v}
  set python.branch         [string range ${python.version} 0 end-1].[string index ${python.version} end]
  set python.bin            ${prefix}/bin/python${python.branch}
  set python.prefix         ${frameworks_dir}/Python.framework/Versions/${python.branch}
  set python.site_packages  "${python.prefix}/lib/python${python.branch}/site-packages"
  set python.pkgname        ""

  subport py${v}-${basename} {
    categories-append       python
    description             Python ${python.version} bindings for ${description}
    long_description        ${long_description} This package provides Python \
                            ${python.version} bindings, modules, and scripts.

    depends_build-append    port:swig-python
    depends_lib-append      port:python${python.version} \
                            port:py${python.version}-numpy

    configure.python        ${python.bin}
    configure.args-replace  --disable-python --enable-python

    destroot.target         install

    post-destroot {
      if {${subport} eq "py27-${basename}"} {
        foreach script [glob -tails -nocomplain -directory ${destroot}${python.prefix}/bin *] {
          file link -symbolic ${destroot}${prefix}/bin/${script} ../Library/Frameworks/Python.framework/Versions/${python.version}/bin/${script}
        }
      }
    }

    livecheck.type          none
  }
}

#------------------------------------------------------------------------
# Use C++ 2014 for High Sierra and beyond, else C++ 2011
#------------------------------------------------------------------------
if {${os.platform} eq "darwin" && ${os.major} >= 17 } {
    use_autoreconf  yes
    use_automake    yes

    compiler.cxx_standard   2014
} else {
    compiler.cxx_standard   2011
}

livecheck.type   regex
livecheck.url    ${master_sites}
livecheck.regex  {gds-swig-(\d+(?:\.\d+)*).tar.gz}
